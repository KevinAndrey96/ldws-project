<head>
  <meta charset="UTF-8">
</head>
  <%total_value=0%>
  <%slots=0%>
  
  <div class="row">
    <h2>Cotización económica</h2>
    <h3>Total de equipos: <%=@total_of_computers%></h3>
    <table class="table table-responsive"  border="1" width= "100%">
      <thead>
        <tr>
          <th>Equipo</th>
          <th>Descripción</th>
          <th>Cantidad</th>
          <th>Valor Unitario</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody>
        <!-- Switches -->
        <tr>
          <td colspan="5"><strong>Switches</strong></td>
        </tr>
        <tr>
          <% if @Sw_status == 0 %>
            <td colspan="5">No hay switches disponibles para cotizar</td>
          <%else%>
          <% 
          totalcomputers=@total_of_computers
          
          while totalcomputers>0  do
            #@Myeq=Equipment.where('ports < ?',totalcomputers).order(:ports).last
            @Myeq=Equipment.where('ports < ? and power = ? and etype = ?',totalcomputers, @eco,"Switch").order(:ports).last
            
            begin
              
            #Calcular Cantidad
            cont=1
            while true
              if @Myeq.ports*cont>totalcomputers
                break
              else
                cont+=1
              end
            end
            cont-=1
            
            #Restar Puertos
            totalcomputers-=@Myeq.ports*cont
            
            
            rescue
            #Añadir router final
            
            #@Myeq=Equipment.where('ports > ?',totalcomputers).order(:ports).first
            @Myeq=Equipment.where('ports > ? and power = ? and etype = ?',totalcomputers,@eco,"Switch").order(:ports).first
            cont=1
            totalcomputers-=@Myeq.ports*cont
            
            end
            slots+=@Myeq.slots*cont
            %>
            
            <tr>
              <td><%=@Myeq.brand%></td>
              <td>Switch marca <%=@Myeq.brand%> de <%=@Myeq.ports%> puertos, referencia: [<%=@Myeq.reference %>], el equipo tiene una potencia <%=@Myeq.power %>/3</td>
              <td><%=cont%></td>
              <td><%=@Myeq.price%></td>
              <td><%=@Myeq.price*cont%></td>
              <%total_value+=@Myeq.price*cont%>
            </tr>
            <%
          
          end
          %>
            
          <%end%>
        </tr>
        <!-- Routers -->
        <tr>
          <td colspan="5"><strong>Routers</strong></td>
        </tr>
        <% if @R_status == 0 %>
            <td colspan="5">No hay routers disponibles para cotizar</td>
          <%else%>
        
        <%
          cont=1
          @Myeq=Equipment.where('power = ? and etype = ?',@eco_r,"Router").order("RANDOM()").first
        %>
        <tr>
          <td><%=@Myeq.brand%></td>
          <td>Router marca <%=@Myeq.brand%>, referencia: [<%=@Myeq.reference %>], el equipo tiene una potencia <%=@Myeq.power %>/3</td>
          <td><%=cont%></td>
          <td><%=@Myeq.price%></td>
          <td><%=@Myeq.price*cont%></td>
          <%total_value+=@Myeq.price*cont%>
        </tr>
        
        <%end%>
        <!-- Rack -->
        <% mslots=35 %>
        <tr>
          <td colspan="5"><strong>Racks</strong></td>
        </tr>
        <% if @R_status == 0 %>
            <td colspan="5">No hay racks disponibles para cotizar</td>
          <%else%>
          
        <%
          
          
          @Myeq=Equipment.where('power = ? and etype = ? and slots >= ?',@eco_ra,"Rack",mslots).order(:slots).first
          
          #Revisamos si hay resultados
          begin
            aux=@Myeq.brand
          rescue
          #Si no hay resultados tendremos que meter varios racks
          
          antslots=0
          ronda=0
            while mslots>0
            ronda+=1
            if ronda!=1
              @BackMy=@Myeq.dup
            end
              begin
                @Myeq=Equipment.where('power = ? and etype = ? and slots <= ?',@eco_ra,"Rack",mslots).order(:slots).last
                mslots-=@Myeq.slots
              rescue
                @Myeq=Equipment.where('power = ? and etype = ? and slots >= ?',@eco_ra,"Rack",mslots).order(:slots).first
                mslots-=@Myeq.slots
              end
              
               #Simulación del siguiente loop
               #if mslots>0
                 
              
              %>
              <tr>
                <td><%=@Myeq.brand%></td>
                <td>Rack marca <%=@Myeq.brand%>, referencia: [<%=@Myeq.reference %>], el equipo tiene espacio para alojar <%=@Myeq.slots %> u</td>
                <td><%=cont%></td>
                <td><%=@Myeq.price%></td>
                <td><%=@Myeq.price*cont%></td>
                <%total_value+=@Myeq.price*cont%>
              </tr>
              <%
            
            end
          end
            
        %>
        
        
        <%end%>
        
        <tr>
          <td colspan="4"><strong>Total: </strong></td>
          <td><strong><%= total_value %> USD</strong></td>
        </tr>
      </tbody>
    </table>
  </div>